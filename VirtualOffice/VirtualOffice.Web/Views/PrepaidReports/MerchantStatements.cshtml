@using ClassLibrary2.Domain
@using Domain.Models
@using VirtualOffice.Web.Infrastructure
@using VirtualOffice.Web.Models
@using VirtualOffice.Web.Models.NewReports
@model VirtualOfficeReportModel
@{
    Layout = "~/Views/Shared/_NewUserLayout.cshtml";

    var columnsCofig = Model.ColumnsConfig;

    var dateRange = Model.DateRange;

    var startDate = dateRange.StartDate;

    var endDate = dateRange.EndDate;
    
    var merchants = ViewBag.Merchants as List<SelectListItem>;

    var userModel = Session[Utils.UserKey] as UserModel;

    var userLevel = userModel != null ? int.Parse(userModel.UserCategory) : 0;

}
<div class="container select" id="main">
    <input id="printLink" type="hidden" value="@Model.PrintLink">
    <input id="storeProcedure" type="hidden" value="@Model.StoreProcedureName">
    <h3 class="text-secundary">Merchant Statements</h3>
    <hr />
    <div class="row">
        <div class="col-xs-12 col-sm-4 col-md-2 col-sm-push-8 col-md-push-10" id="sidebar">
            <div class="panel-group" id="accordion">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <a data-toggle="collapse" data-target="#collapse1" class="expand">Elements on Report <span class="glyphicon glyphicon-chevron-down pull-right"></span></a>
                    </div>
                    <div class="panel-body panel-collapse collapse" id="collapse1">
                        <label for="last-visit" class="control-label">Columns to show:</label>
                        <div class="panel-body">
                            <div class="form-group">
                                @foreach (var column in columnsCofig.Keys)
                                {
                                    <div class="checkbox">
                                        <label id=@string.Format("label^{0}", column)>

                                            @Html.CheckBox("columnName^" + column, !columnsCofig[column].Hidden, new { @value = column, onchange = "UpdateDataProjection()" })@column

                                        </label>
                                    </div>
                                }
                                <div class="checkbox">
                                    <label class="text-secundary">
                                        @Html.CheckBox("saveOutputAsDefault")Save as default
                                    </label>
                                </div>
                            </div>
                            <div class="">
                                <button type="button" class="btn btn-secundary" onclick="applyUserfilters()">Go!</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <a data-toggle="collapse" data-target="#collapse2" class="expand">Filters: <span class="glyphicon glyphicon-chevron-down pull-right"></span></a>
                    </div>
                    <div class="panel-body panel-collapse" id="collapse2">

                        <label>Merchant: </label>
                        @(Html.DropDownList("merchantId", merchants, new { @class = "form-control" }))
                        <br>
                        <label>Start Date: </label>
                        @(Html.Kendo().DatePicker().Name("startDate").Value(startDate).HtmlAttributes(new { style = "width: 115px;" }))
                        <br>
                        <label>End Date: </label>
                        @(Html.Kendo().DatePicker().Name("endDate").Value(endDate).HtmlAttributes(new { style = "width: 115px;" }))
                        <br>
                        <div class="">
                            <button type="button" class="btn btn-secundary" onclick="applyUserfilters()">Go!</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xs-12 col-sm-8 col-md-10 col-sm-pull-4 col-md-pull-2">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <div class="row">
                        <div class="hidden-xs col-sm-9 col-md-9">
                            <h4 class="">Your Results</h4>
                        </div>
                        <div class="col-xs-4 col-sm-3 col-md-3 text-right">
                            <a class="btn btn-print btn-sm" id="PrintReportsBtn" onclick="PrintReport(false)"><span class="glyphicon glyphicon-print"></span> Print</a>
                            <a id="exportButton" class="btn btn-print btn-sm" onclick="PrintReport(true)"><span class="glyphicon glyphicon-export"></span> Export</a>
                        </div>
                    </div>
                </div>
                <div class="panel-body-kendo">
                    @(Html.Kendo().Grid<MerchantStatementResultViewModel>()
                          .Name("Reports")
                                  .HtmlAttributes(new { @style = "text-align: left; height: 450px" }).EnableCustomBinding(true)
                          .Columns(col =>
                          {
                              foreach (var column in columnsCofig.Keys)
                              {
                                  var columnConfig = columnsCofig[column];
                                  var label = columnsCofig[column].Label;
                                  var columnResult = col.Bound(column).Width(columnConfig.Width).Hidden(columnConfig.Hidden || columnConfig.Level > userLevel).Title(label);

                                  if (!string.IsNullOrEmpty(columnConfig.Link))
                                  {
                                      columnResult = columnResult.ClientTemplate(columnConfig.Link);
                                  }

                                  if (columnConfig.IsDate)
                                      columnResult.Format("{0:dd/MM/yyyy}");

                                  else if (columnConfig.IsNumeric)
                                      columnResult.ClientFooterTemplate("$#=sum#").Format("{0:c}");
                              }

                          })
                          .DataSource(ds => ds.Ajax()
                              .Aggregates(aggregates =>
                              {
                                  foreach (var col in columnsCofig.Where(col => col.Value.IsNumeric))
                                  {
                                      aggregates.Add(col.Key, typeof(double)).Sum();
                                  }
                              })
                              .Read(r => r.Action("RunMerchantStatements", "PrepaidReports").Data("getReportParams"))
                              .PageSize(100)
                          )
                          .Events(ev => ev.ColumnReorder("saveNewOutPutOrder").ColumnResize("saveColumnWidth"))
                          .Resizable(config => config.Columns(true))
                          .Sortable()
                          .Selectable()
                          .Reorderable(reorder => reorder.Columns(true))
                          .Scrollable(scr => scr.Height(600))
                          .Pageable(page => page.PageSizes(true))
                          .AutoBind(true)
                    )
                </div>


            </div>
        </div>
    </div>
</div> <!-- .container.select#main -->

<script src="~/Scripts/reportManager.js"></script>